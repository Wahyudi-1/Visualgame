<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Kamera: Tangkap Huruf</title>
    
    <!-- Tailwind CSS untuk styling UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google MediaPipe untuk Pelacakan Tangan -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        
        #webcam { display: none; }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            transform: scaleX(-1); /* Efek cermin untuk seluruh kanvas */
            object-fit: cover;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
        
        .score-pop {
            position: absolute;
            font-weight: bold;
            font-size: 2.5rem;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
            z-index: 20;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        
        /* Mencegah seleksi teks saat bermain */
        .no-select { user-select: none; -webkit-user-select: none; }

        /* Custom Scrollbar untuk grid huruf */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- UI Layer -->
    <div id="ui-layer" class="flex flex-col justify-center items-center no-select">
        
        <!-- Menu Mulai -->
        <div id="start-menu" class="pointer-events-auto bg-gray-900 bg-opacity-90 p-8 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-md w-full mx-4 transition-all duration-500">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                TANGKAP HURUF
            </h1>
            <p class="text-gray-400 text-sm mb-6 uppercase tracking-widest font-semibold">Kamera Interaktif</p>
            
            <div class="text-left text-gray-300 mb-6 space-y-2 text-sm bg-gray-800 p-4 rounded-xl">
                <p>‚è±Ô∏è Anda memiliki waktu <span class="text-yellow-400 font-bold">3 Menit</span>.</p>
                <p>üéØ Pilih satu huruf target. Sentuh gelembung huruf tersebut (Besar/Kecil) untuk <span class="text-green-400 font-bold">+10 Poin</span>.</p>
                <p>‚ò†Ô∏è Jika menyentuh huruf lain, Anda akan terkena <span class="text-red-500 font-bold">-10 Poin</span>.</p>
                <p>ü§è Tekuk jari telunjuk ke jempol untuk efek klik.</p>
            </div>

            <button id="start-btn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-2xl shadow-[0_0_15px_rgba(59,130,246,0.5)] transition-all transform hover:scale-105 active:scale-95 text-xl">
                Mulai (Layar Penuh)
            </button>
        </div>

        <!-- Menu Pilih Huruf (Awalnya Sembunyi) -->
        <div id="letter-selection" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-6 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-lg w-full mx-4 transition-all duration-500 max-h-[90vh] flex-col">
            <h2 class="text-2xl font-bold text-white mb-2">Pilih Huruf Target Anda</h2>
            <p class="text-gray-400 text-sm mb-4">Pilih satu huruf untuk ditangkap selama permainan.</p>
            
            <div id="letter-grid" class="grid grid-cols-5 sm:grid-cols-6 gap-3 overflow-y-auto custom-scrollbar p-2 mb-4">
                <!-- Tombol A-Z akan dimuat di sini menggunakan Javascript -->
            </div>

            <p id="loading-text" class="text-yellow-400 mt-2 text-sm hidden font-semibold animate-pulse">
                Menghidupkan Kamera & AI (Mohon tunggu)...
            </p>
        </div>

        <!-- HUD: Skor, Target & Indikator Timer -->
        <div id="hud" class="absolute top-0 left-0 w-full p-4 flex justify-between items-start hidden">
            <div class="flex gap-4">
                <!-- Papan Target -->
                <div class="bg-blue-900 bg-opacity-80 backdrop-blur-md rounded-2xl p-4 border border-blue-500 shadow-lg min-w-[100px] text-center">
                    <p class="text-blue-200 text-xs font-bold uppercase tracking-widest mb-1">TARGET</p>
                    <p id="target-display" class="text-4xl font-black text-white">A</p>
                </div>
                <!-- Papan Skor -->
                <div class="bg-gray-900 bg-opacity-75 backdrop-blur-md rounded-2xl p-4 border border-gray-700 shadow-lg min-w-[120px] text-center">
                    <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">SKOR</p>
                    <p id="score-display" class="text-4xl font-black text-white transition-colors duration-300">0</p>
                </div>
            </div>
            
            <div class="flex flex-col gap-2 items-end">
                <!-- Papan Timer -->
                <div id="timer-box" class="bg-gray-900 bg-opacity-75 backdrop-blur-md rounded-2xl p-3 border border-gray-700 shadow-lg min-w-[100px] text-center">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">WAKTU</p>
                    <p id="timer-display" class="text-3xl font-mono font-bold text-yellow-400">03:00</p>
                </div>
                <button onclick="exitFullscreenAndReload()" class="bg-red-500 bg-opacity-80 text-white text-xs font-bold px-3 py-2 rounded-xl pointer-events-auto hover:bg-red-600 shadow-lg backdrop-blur-md transition-transform hover:scale-105 mt-1">
                    Akhiri Game
                </button>
            </div>
        </div>

        <!-- Layar Game Over -->
        <div id="game-over" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-8 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-md w-full mx-4 transform scale-105">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500 mb-2">
                WAKTU HABIS!
            </h1>
            <p class="text-gray-300 mb-6 text-lg">Permainan Selesai.</p>
            
            <div class="bg-gray-800 p-6 rounded-2xl mb-6 border border-gray-700">
                <p class="text-gray-400 text-sm uppercase tracking-widest mb-2">Skor Akhir Anda</p>
                <p id="final-score" class="text-6xl font-black text-white">0</p>
            </div>

            <button onclick="exitFullscreenAndReload()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition-all transform hover:scale-105 active:scale-95 text-xl">
                Main Lagi
            </button>
        </div>

    </div>

    <video id="webcam" autoplay playsinline></video>
    <canvas id="game-canvas"></canvas>

    <script>
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('game-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        const startMenu = document.getElementById('start-menu');
        const startBtn = document.getElementById('start-btn');
        const letterSelection = document.getElementById('letter-selection');
        const letterGrid = document.getElementById('letter-grid');
        const loadingText = document.getElementById('loading-text');
        
        const hud = document.getElementById('hud');
        const scoreDisplay = document.getElementById('score-display');
        const targetDisplay = document.getElementById('target-display');
        const timerDisplay = document.getElementById('timer-display');
        const timerBox = document.getElementById('timer-box');
        
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreDisplay = document.getElementById('final-score');

        // Konstanta & Status Game
        const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let isGameRunning = false;
        let score = 0;
        let targetLetter = 'A';
        let timeRemaining = 180; // 3 menit = 180 detik
        
        let bubbles = [];
        let particles = [];
        let indexFingerTips = []; 
        let clickRipples = []; 
        let handClickStates = {}; 
        let lastFrameTime = performance.now();
        let spawnTimer = 0;

        // --- INISIALISASI UI PILIH HURUF ---
        function initLetterGrid() {
            ALPHABET.split('').forEach(letter => {
                const btn = document.createElement('button');
                btn.innerText = letter;
                btn.className = "bg-gray-800 border border-gray-600 hover:bg-blue-600 hover:border-blue-400 text-white font-bold py-3 rounded-xl text-xl transition-all shadow-sm transform hover:scale-110 active:scale-95";
                btn.onclick = () => selectTargetLetter(letter);
                letterGrid.appendChild(btn);
            });
        }
        initLetterGrid();

        // Mengatur Ukuran Canvas
        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- FUNGSI FULLSCREEN ---
        function requestFullScreen() {
            const docElm = document.documentElement;
            if (docElm.requestFullscreen) { docElm.requestFullscreen(); }
            else if (docElm.mozRequestFullScreen) { docElm.mozRequestFullScreen(); }
            else if (docElm.webkitRequestFullScreen) { docElm.webkitRequestFullScreen(); }
            else if (docElm.msRequestFullscreen) { docElm.msRequestFullscreen(); }
        }

        function exitFullscreenAndReload() {
            if (document.exitFullscreen) { document.exitFullscreen(); }
            else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
            setTimeout(() => location.reload(), 300);
        }

        // --- MEDIA PIPE (AI TANGAN) ---
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults((results) => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // Gambar Background Kamera Proporsional
            const videoRatio = results.image.width / results.image.height;
            const canvasRatio = canvasElement.width / canvasElement.height;
            let drawWidth, drawHeight, startX, startY;

            if (canvasRatio > videoRatio) {
                drawWidth = canvasElement.width;
                drawHeight = canvasElement.width / videoRatio;
                startX = 0;
                startY = (canvasElement.height - drawHeight) / 2;
            } else {
                drawHeight = canvasElement.height;
                drawWidth = canvasElement.height * videoRatio;
                startX = (canvasElement.width - drawWidth) / 2;
                startY = 0;
            }
            canvasCtx.drawImage(results.image, startX, startY, drawWidth, drawHeight);
            canvasCtx.restore();

            indexFingerTips = [];
            if (results.multiHandLandmarks) {
                results.multiHandLandmarks.forEach((landmarks, index) => {
                    const indexTip = landmarks[8];
                    const indexPIP = landmarks[6];
                    const middleTip = landmarks[12];
                    const middlePIP = landmarks[10];
                    const thumbTip = landmarks[4];

                    // V-sign untuk menyembunyikan pointer
                    if (indexTip.y < indexPIP.y && middleTip.y < middlePIP.y) {
                        handClickStates[index] = false;
                        return; 
                    }

                    // Deteksi Pinch/Klik
                    const isClicking = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y) < 0.06;

                    let actualX = (indexTip.x * drawWidth) + startX;
                    let actualY = (indexTip.y * drawHeight) + startY;

                    indexFingerTips.push({ x: actualX, y: actualY, isClicking: isClicking, handIndex: index });
                });
            }

            if (isGameRunning) {
                updateAndDrawGame();
            } else if (loadingText.style.display === 'block') {
                startGamePlay(); // Kamera AI sudah siap, mulai game!
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 1280, height: 720
        });

        // --- KONTROL UI & ALUR GAME ---
        startBtn.addEventListener('click', () => {
            requestFullScreen();
            startMenu.style.display = 'none';
            letterSelection.style.display = 'flex';
        });

        function selectTargetLetter(letter) {
            targetLetter = letter;
            targetDisplay.innerText = letter;
            
            // Sembunyikan grid, tampilkan loading kamera
            letterGrid.style.display = 'none';
            document.querySelector('#letter-selection h2').innerText = "Mempersiapkan...";
            document.querySelector('#letter-selection p').style.display = 'none';
            loadingText.style.display = 'block';

            // Nyalakan Kamera
            camera.start().catch(err => {
                alert("Gagal mengakses kamera. Pastikan memberikan izin!");
                location.reload();
            });
        }

        function startGamePlay() {
            loadingText.style.display = 'none';
            letterSelection.style.display = 'none';
            hud.style.display = 'flex';
            
            isGameRunning = true;
            score = 0;
            timeRemaining = 180;
            bubbles = [];
            updateScoreDisplay();
            lastFrameTime = performance.now();
        }

        function showGameOverScreen() {
            isGameRunning = false;
            hud.style.display = 'none';
            gameOverScreen.style.display = 'block';
            finalScoreDisplay.innerText = score;
            
            // Efek suara/warna sesuai skor
            if(score < 0) {
                finalScoreDisplay.classList.add('text-red-500');
                finalScoreDisplay.classList.remove('text-white');
            }
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // --- LOGIKA GAME ---
        function spawnBubble() {
            // 35% kemungkinan muncul target, 65% huruf acak
            let isTargetObj = Math.random() < 0.35; 
            let spawnedLetter = targetLetter;

            if (!isTargetObj) {
                do {
                    spawnedLetter = ALPHABET[Math.floor(Math.random() * ALPHABET.length)];
                } while (spawnedLetter === targetLetter);
            }

            // Acak Uppercase atau Lowercase
            if (Math.random() < 0.5) {
                spawnedLetter = spawnedLetter.toLowerCase();
            }

            const radius = Math.random() * 15 + 35; // Ukuran gelembung
            bubbles.push({
                x: Math.random() * (canvasElement.width - radius * 2) + radius,
                y: -radius - 50,
                radius: radius,
                letter: spawnedLetter,
                isTarget: isTargetObj, // Meskipun lowercase, secara logika tetap dianggap target
                speedY: Math.random() * 3 + 3, 
                speedX: (Math.random() - 0.5) * 2,
                rotation: 0,
                rotSpeed: (Math.random() - 0.5) * 0.1
            });
        }

        function createParticles(x, y, color) {
            for(let i=0; i<15; i++){
                particles.push({
                    x: x, y: y, vx: (Math.random() - 0.5) * 15, vy: (Math.random() - 0.5) * 15, life: 1.0, color: color
                });
            }
        }

        function showFloatingText(x, y, text, isPositive) {
            const el = document.createElement('div');
            el.className = `score-pop ${isPositive ? 'text-green-400' : 'text-red-500'}`;
            el.innerText = text;
            const mirroredX = window.innerWidth - x; 
            
            el.style.left = `${mirroredX - 25}px`;
            el.style.top = `${y - 25}px`;
            document.getElementById('ui-layer').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function updateScoreDisplay() {
            scoreDisplay.innerText = score;
            if(score < 0) scoreDisplay.classList.add('text-red-400');
            else scoreDisplay.classList.remove('text-red-400');
        }

        function updateAndDrawGame() {
            const now = performance.now();
            const dt = (now - lastFrameTime) / 1000;
            lastFrameTime = now;

            // Timer Logic
            timeRemaining -= dt;
            if (timeRemaining <= 0) {
                timeRemaining = 0;
                showGameOverScreen();
                return;
            }
            
            timerDisplay.innerText = formatTime(timeRemaining);
            // Beri warna merah berkedip jika sisa < 10 detik
            if (timeRemaining < 10) {
                timerBox.classList.add('border-red-500');
                timerDisplay.classList.add('text-red-500');
                timerDisplay.classList.remove('text-yellow-400');
            }

            // Spawn Bubble
            spawnTimer += dt;
            if (spawnTimer > 0.8) { 
                spawnBubble();
                spawnTimer = 0;
            }

            // Update & Gambar Bubble
            for (let i = bubbles.length - 1; i >= 0; i--) {
                let b = bubbles[i];
                b.y += b.speedY;
                b.x += b.speedX;
                b.rotation += b.rotSpeed;

                if (b.x < b.radius || b.x > canvasElement.width - b.radius) b.speedX *= -1;

                // Deteksi Tabrakan
                let isTouched = false;
                for (let pointer of indexFingerTips) {
                    const dist = Math.hypot(pointer.x - b.x, pointer.y - b.y);
                    if (dist < b.radius + 15) { isTouched = true; break; }
                }

                if (isTouched) {
                    if (b.isTarget) {
                        score += 10;
                        showFloatingText(b.x, b.y, "+10", true);
                        createParticles(b.x, b.y, '#4ade80'); // Partikel hijau
                    } else {
                        score -= 10;
                        showFloatingText(b.x, b.y, "-10", false);
                        createParticles(b.x, b.y, '#ef4444'); // Partikel merah
                        canvasCtx.fillStyle = 'rgba(255, 0, 0, 0.3)'; // Layar kedip merah
                        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
                    }
                    
                    updateScoreDisplay();
                    bubbles.splice(i, 1);
                    continue;
                }

                if (b.y > canvasElement.height + b.radius) {
                    bubbles.splice(i, 1);
                    continue;
                }

                // Render Gelembung (Bubble)
                canvasCtx.save();
                canvasCtx.translate(b.x, b.y);
                canvasCtx.rotate(b.rotation);
                
                // Lapisan Kaca Bubble
                canvasCtx.beginPath();
                canvasCtx.arc(0, 0, b.radius, 0, Math.PI * 2);
                canvasCtx.fillStyle = 'rgba(30, 64, 175, 0.5)'; // Biru semi transparan
                canvasCtx.fill();
                canvasCtx.lineWidth = 3;
                canvasCtx.strokeStyle = 'rgba(96, 165, 250, 0.8)';
                canvasCtx.stroke();
                
                // Highlight Kaca agar terlihat seperti gelembung
                canvasCtx.beginPath();
                canvasCtx.arc(-b.radius*0.3, -b.radius*0.3, b.radius*0.3, 0, Math.PI * 2);
                canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                canvasCtx.fill();

                // Render Teks (Huruf) di dalam Bubble
                // PENTING: Karena canvas di-mirror secara CSS scaleX(-1), kita harus scale ulang teksnya
                // agar huruf tidak terbalik saat dibaca!
                canvasCtx.scale(-1, 1); 
                canvasCtx.fillStyle = '#ffffff';
                canvasCtx.font = `bold ${b.radius}px 'Segoe UI', Arial`;
                canvasCtx.textAlign = 'center';
                canvasCtx.textBaseline = 'middle';
                // Tambahkan bayangan hitam sedikit agar huruf jelas
                canvasCtx.shadowColor = 'rgba(0,0,0,0.8)';
                canvasCtx.shadowBlur = 5;
                canvasCtx.fillText(b.letter, 0, 0);

                canvasCtx.restore();
            }

            // Render Partikel
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= dt * 2.5; 

                if (p.life <= 0) { particles.splice(i, 1); continue; }

                canvasCtx.globalAlpha = p.life;
                canvasCtx.beginPath();
                canvasCtx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                canvasCtx.fillStyle = p.color;
                canvasCtx.fill();
            }
            canvasCtx.globalAlpha = 1.0;

            // Indikator Jari & Efek Ripple Klik
            for (let pointer of indexFingerTips) {
                if (pointer.isClicking && !handClickStates[pointer.handIndex]) {
                    clickRipples.push({ x: pointer.x, y: pointer.y, radius: 15, alpha: 1.0 });
                    handClickStates[pointer.handIndex] = true;
                } else if (!pointer.isClicking) {
                    handClickStates[pointer.handIndex] = false;
                }

                canvasCtx.beginPath();
                canvasCtx.arc(pointer.x, pointer.y, 18, 0, Math.PI * 2);
                canvasCtx.fillStyle = pointer.isClicking ? 'rgba(255, 255, 255, 0.9)' : 'rgba(56, 189, 248, 0.6)';
                canvasCtx.shadowColor = pointer.isClicking ? '#ffffff' : '#38bdf8';
                canvasCtx.shadowBlur = 20;
                canvasCtx.fill();
                canvasCtx.lineWidth = 3;
                canvasCtx.strokeStyle = '#ffffff';
                canvasCtx.stroke();
                canvasCtx.shadowBlur = 0;
            }

            // Animasi Gelombang (Ripple)
            for (let i = clickRipples.length - 1; i >= 0; i--) {
                let r = clickRipples[i];
                r.radius += dt * 300; 
                r.alpha -= dt * 2.5;  

                if (r.alpha <= 0) { clickRipples.splice(i, 1); continue; }

                canvasCtx.beginPath();
                canvasCtx.arc(r.x, r.y, r.radius, 0, Math.PI * 2);
                canvasCtx.strokeStyle = `rgba(255, 255, 255, ${r.alpha})`;
                canvasCtx.lineWidth = 5 * r.alpha;
                canvasCtx.stroke();
            }
        }
    </script>
</body>
</html>
