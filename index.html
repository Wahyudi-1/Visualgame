<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Kamera: Tangkap Objek</title>
    
    <!-- Tailwind CSS untuk styling UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google MediaPipe untuk Pelacakan Tangan -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        
        #webcam { display: none; }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            transform: scaleX(-1); /* Efek cermin untuk seluruh kanvas */
            object-fit: cover;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
        
        .score-pop {
            position: absolute;
            font-weight: bold;
            font-size: 2.5rem;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
            z-index: 20;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        
        .no-select { user-select: none; -webkit-user-select: none; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    </style>
</head>
<body>

    <!-- UI Layer -->
    <div id="ui-layer" class="flex flex-col justify-center items-center no-select">
        
        <!-- Menu Mulai -->
        <div id="start-menu" class="pointer-events-auto bg-gray-900 bg-opacity-90 p-8 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-md w-full mx-4 transition-all duration-500">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">
                TANGKAP OBJEK
            </h1>
            <p class="text-gray-400 text-sm mb-6 uppercase tracking-widest font-semibold">Kamera Interaktif</p>
            
            <div class="text-left text-gray-300 mb-6 space-y-2 text-sm bg-gray-800 p-4 rounded-xl">
                <p>‚è±Ô∏è Anda memiliki waktu <span class="text-yellow-400 font-bold">3 Menit</span>.</p>
                <p>üéØ Pilih mode permainan dan target yang ingin ditangkap untuk <span class="text-green-400 font-bold">+10 Poin</span>.</p>
                <p>üí• Hati-hati! Menyentuh objek yang salah akan mengurangi <span class="text-red-500 font-bold">-10 Poin</span>.</p>
                <p>üîä Pastikan volume Anda menyala untuk efek suara!</p>
            </div>

            <button id="start-btn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-2xl shadow-[0_0_15px_rgba(59,130,246,0.5)] transition-all transform hover:scale-105 active:scale-95 text-xl">
                Mulai (Layar Penuh)
            </button>
        </div>

        <!-- Menu Pilih Mode Permainan -->
        <div id="mode-selection" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-6 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-lg w-full mx-4 transition-all duration-500 flex-col">
            <h2 class="text-2xl font-bold text-white mb-2">Pilih Mode Permainan</h2>
            <p class="text-gray-400 text-sm mb-6">Apa yang ingin Anda tangkap hari ini?</p>
            
            <div class="grid grid-cols-1 gap-4 mb-4">
                <button onclick="selectMode('huruf')" class="bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-400 hover:to-blue-500 text-white font-bold py-4 px-6 rounded-xl text-xl transition-transform hover:scale-105 shadow-lg flex items-center justify-between">
                    <span>üî§ Huruf A - Z</span>
                    <span class="text-sm bg-black bg-opacity-30 px-3 py-1 rounded-full">Besar & Kecil</span>
                </button>
                <button onclick="selectMode('angka')" class="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 text-white font-bold py-4 px-6 rounded-xl text-xl transition-transform hover:scale-105 shadow-lg flex items-center justify-between">
                    <span>üî¢ Angka 0 - 30</span>
                    <span class="text-sm bg-black bg-opacity-30 px-3 py-1 rounded-full">Matematika</span>
                </button>
                <button onclick="selectMode('warna')" class="bg-gradient-to-r from-rose-500 to-orange-500 hover:from-rose-400 hover:to-orange-400 text-white font-bold py-4 px-6 rounded-xl text-xl transition-transform hover:scale-105 shadow-lg flex items-center justify-between">
                    <span>üé® Aneka Warna</span>
                    <span class="text-sm bg-black bg-opacity-30 px-3 py-1 rounded-full">Visual</span>
                </button>
            </div>
        </div>

        <!-- Menu Pilih Target Spesifik -->
        <div id="target-selection" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-6 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-xl w-full mx-4 transition-all duration-500 max-h-[90vh] flex-col">
            <h2 id="target-title" class="text-2xl font-bold text-white mb-2">Pilih Target Anda</h2>
            <p class="text-gray-400 text-sm mb-4">Pilih satu target utama untuk ditangkap.</p>
            
            <div id="target-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-3 overflow-y-auto custom-scrollbar p-2 mb-4 max-h-[60vh]">
                <!-- Tombol Target akan dimuat di sini menggunakan Javascript -->
            </div>

            <button onclick="backToModeSelection()" id="back-btn" class="mt-2 text-gray-400 hover:text-white text-sm underline pb-2">Kembali Pilih Mode</button>

            <p id="loading-text" class="text-yellow-400 mt-2 text-sm hidden font-semibold animate-pulse">
                Menghidupkan Kamera & AI (Mohon tunggu)...
            </p>
        </div>

        <!-- HUD: Skor, Target & Indikator Timer -->
        <div id="hud" class="absolute top-0 left-0 w-full p-4 flex justify-between items-start hidden">
            <div class="flex gap-4">
                <!-- Papan Target -->
                <div class="bg-blue-900 bg-opacity-80 backdrop-blur-md rounded-2xl p-4 border border-blue-500 shadow-lg min-w-[100px] text-center flex flex-col items-center justify-center">
                    <p class="text-blue-200 text-[10px] font-bold uppercase tracking-widest mb-1">TARGET</p>
                    <div id="target-display" class="text-3xl font-black text-white">A</div>
                </div>
                <!-- Papan Skor -->
                <div class="bg-gray-900 bg-opacity-75 backdrop-blur-md rounded-2xl p-4 border border-gray-700 shadow-lg min-w-[100px] text-center">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">SKOR</p>
                    <p id="score-display" class="text-4xl font-black text-white transition-colors duration-300">0</p>
                </div>
            </div>
            
            <div class="flex flex-col gap-2 items-end">
                <!-- Papan Timer -->
                <div id="timer-box" class="bg-gray-900 bg-opacity-75 backdrop-blur-md rounded-2xl p-3 border border-gray-700 shadow-lg min-w-[100px] text-center">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">WAKTU</p>
                    <p id="timer-display" class="text-3xl font-mono font-bold text-yellow-400">03:00</p>
                </div>
                <button onclick="exitFullscreenAndReload()" class="bg-red-500 bg-opacity-80 text-white text-xs font-bold px-3 py-2 rounded-xl pointer-events-auto hover:bg-red-600 shadow-lg backdrop-blur-md transition-transform hover:scale-105 mt-1">
                    Akhiri Game
                </button>
            </div>
        </div>

        <!-- Layar Game Over -->
        <div id="game-over" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-8 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-md w-full mx-4 transform scale-105">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500 mb-2">
                WAKTU HABIS!
            </h1>
            <p class="text-gray-300 mb-6 text-lg">Permainan Selesai.</p>
            
            <div class="bg-gray-800 p-6 rounded-2xl mb-6 border border-gray-700">
                <p class="text-gray-400 text-sm uppercase tracking-widest mb-2">Skor Akhir Anda</p>
                <p id="final-score" class="text-6xl font-black text-white">0</p>
            </div>

            <button onclick="exitFullscreenAndReload()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition-all transform hover:scale-105 active:scale-95 text-xl">
                Main Lagi
            </button>
        </div>

    </div>

    <video id="webcam" autoplay playsinline></video>
    <canvas id="game-canvas"></canvas>

    <script>
        // --- DEKLARASI ELEMEN ---
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('game-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        const startMenu = document.getElementById('start-menu');
        const modeSelectionMenu = document.getElementById('mode-selection');
        const targetSelectionMenu = document.getElementById('target-selection');
        const targetGrid = document.getElementById('target-grid');
        const loadingText = document.getElementById('loading-text');
        
        const hud = document.getElementById('hud');
        const scoreDisplay = document.getElementById('score-display');
        const targetDisplay = document.getElementById('target-display');
        const timerDisplay = document.getElementById('timer-display');
        const timerBox = document.getElementById('timer-box');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreDisplay = document.getElementById('final-score');
        const backBtn = document.getElementById('back-btn');

        // --- SISTEM SUARA (WEB AUDIO API) ---
        let audioCtx;
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // Suara Sorakan / Benar (Ting-ting cepat yang ceria)
        function playCorrectSound() {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.type = 'sine';
            const now = audioCtx.currentTime;
            
            // Nada melompat tinggi (Arpeggio ceria)
            osc.frequency.setValueAtTime(523.25, now); // C5
            osc.frequency.setValueAtTime(659.25, now + 0.1); // E5
            osc.frequency.setValueAtTime(783.99, now + 0.2); // G5
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.3, now + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            
            osc.start(now);
            osc.stop(now + 0.4);
        }

        // Suara Ledakan / Salah (Distorsi rendah & gemuruh)
        function playWrongSound() {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.type = 'square'; // Waveform kasar seperti ledakan
            const now = audioCtx.currentTime;
            
            // Frekuensi drop cepat (Efek bom jatuh)
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.exponentialRampToValueAtTime(30, now + 0.3);
            
            gainNode.gain.setValueAtTime(0.5, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            
            osc.start(now);
            osc.stop(now + 0.4);
        }

        // --- KONSTANTA & DATA PERMAINAN ---
        const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
        const NUMBERS = Array.from({length: 31}, (_, i) => i.toString());
        const COLORS = [
            { id: 'Merah', hex: '#ef4444' }, { id: 'Biru', hex: '#3b82f6' },
            { id: 'Hijau', hex: '#22c55e' }, { id: 'Kuning', hex: '#eab308' },
            { id: 'Ungu', hex: '#a855f7' }, { id: 'Oranye', hex: '#f97316' },
            { id: 'Pink', hex: '#ec4899' }, { id: 'Putih', hex: '#ffffff' },
            { id: 'Abu-abu', hex: '#6b7280' }, { id: 'Coklat', hex: '#78350f' }
        ];

        let currentMode = ''; 
        let isGameRunning = false;
        let score = 0;
        let targetData = null; // Menyimpan data target yang dipilih
        let timeRemaining = 180; // 3 menit
        
        let bubbles = [];
        let particles = [];
        let indexFingerTips = []; 
        let lastFrameTime = performance.now();
        let spawnTimer = 0;

        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function requestFullScreen() {
            const docElm = document.documentElement;
            if (docElm.requestFullscreen) docElm.requestFullscreen();
            else if (docElm.mozRequestFullScreen) docElm.mozRequestFullScreen();
            else if (docElm.webkitRequestFullScreen) docElm.webkitRequestFullScreen();
        }

        function exitFullscreenAndReload() {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            setTimeout(() => location.reload(), 300);
        }

        // --- LOGIKA UI ALUR MENU ---
        document.getElementById('start-btn').addEventListener('click', () => {
            initAudio(); // Inisialisasi Audio saat interaksi pertama
            requestFullScreen();
            startMenu.style.display = 'none';
            modeSelectionMenu.style.display = 'flex';
        });

        function selectMode(mode) {
            initAudio();
            currentMode = mode;
            modeSelectionMenu.style.display = 'none';
            targetSelectionMenu.style.display = 'flex';
            
            const titleEl = document.getElementById('target-title');
            if(mode === 'huruf') titleEl.innerText = "Pilih Huruf Target";
            else if(mode === 'angka') titleEl.innerText = "Pilih Angka Target";
            else if(mode === 'warna') titleEl.innerText = "Pilih Warna Target";

            populateTargetGrid();
        }

        function backToModeSelection() {
            targetSelectionMenu.style.display = 'none';
            modeSelectionMenu.style.display = 'flex';
        }

        function populateTargetGrid() {
            targetGrid.innerHTML = '';
            let items = [];
            
            if (currentMode === 'huruf') items = ALPHABET;
            else if (currentMode === 'angka') items = NUMBERS;
            else if (currentMode === 'warna') items = COLORS;

            // Mengatur kolom grid berdasarkan mode
            targetGrid.className = `grid gap-3 overflow-y-auto custom-scrollbar p-2 mb-4 max-h-[60vh] ${currentMode === 'angka' ? 'grid-cols-5 sm:grid-cols-7' : 'grid-cols-4 sm:grid-cols-6'}`;

            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "bg-gray-800 border border-gray-600 hover:bg-blue-600 hover:border-blue-400 text-white font-bold py-3 rounded-xl transition-all shadow-sm transform hover:scale-110 active:scale-95 flex flex-col items-center justify-center min-h-[60px]";
                
                if (currentMode === 'warna') {
                    btn.innerHTML = `<div class="w-8 h-8 rounded-full shadow-inner mb-1 border border-gray-400" style="background-color: ${item.hex}"></div><span class="text-[10px] uppercase">${item.id}</span>`;
                    btn.onclick = () => selectFinalTarget(item); // Objek warna
                } else {
                    btn.innerText = item;
                    btn.className += " text-xl";
                    btn.onclick = () => selectFinalTarget(item); // String (Huruf/Angka)
                }
                
                targetGrid.appendChild(btn);
            });
        }

        function selectFinalTarget(target) {
            initAudio();
            targetData = target;
            
            // Perbarui UI HUD Target
            targetDisplay.innerHTML = '';
            if (currentMode === 'warna') {
                targetDisplay.innerHTML = `<div class="w-10 h-10 rounded-full shadow-lg border-2 border-white" style="background-color: ${target.hex}"></div>`;
            } else {
                targetDisplay.innerText = target;
            }
            
            targetGrid.style.display = 'none';
            backBtn.style.display = 'none';
            document.querySelector('#target-selection h2').innerText = "Mempersiapkan AI...";
            document.querySelector('#target-selection p').style.display = 'none';
            loadingText.style.display = 'block';

            camera.start().catch(err => {
                alert("Gagal mengakses kamera. Pastikan memberikan izin!");
                location.reload();
            });
        }

        function startGamePlay() {
            loadingText.style.display = 'none';
            targetSelectionMenu.style.display = 'none';
            hud.style.display = 'flex';
            
            isGameRunning = true;
            score = 0;
            timeRemaining = 180;
            bubbles = [];
            updateScoreDisplay();
            lastFrameTime = performance.now();
        }

        function showGameOverScreen() {
            isGameRunning = false;
            hud.style.display = 'none';
            gameOverScreen.style.display = 'block';
            finalScoreDisplay.innerText = score;
            if(score < 0) finalScoreDisplay.classList.replace('text-white', 'text-red-500');
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // --- LOGIKA GAME (SPAWN & COLLISION) ---
        function spawnBubble() {
            let isTargetObj = Math.random() < 0.35; 
            let spawnedData;
            
            // Tentukan apa yang di-spawn berdasarkan Mode
            if (currentMode === 'huruf') {
                spawnedData = isTargetObj ? targetData : ALPHABET[Math.floor(Math.random() * ALPHABET.length)];
                if(!isTargetObj && spawnedData === targetData) spawnedData = 'X'; // Hindari duplikat kebetulan
                if (Math.random() < 0.5) spawnedData = spawnedData.toLowerCase(); // 50% Lowercase
            } 
            else if (currentMode === 'angka') {
                spawnedData = isTargetObj ? targetData : NUMBERS[Math.floor(Math.random() * NUMBERS.length)];
                if(!isTargetObj && spawnedData === targetData) spawnedData = '99'; 
            }
            else if (currentMode === 'warna') {
                spawnedData = isTargetObj ? targetData : COLORS[Math.floor(Math.random() * COLORS.length)];
                if(!isTargetObj && spawnedData.id === targetData.id) spawnedData = COLORS.find(c => c.id !== targetData.id);
            }

            const radius = currentMode === 'warna' ? Math.random() * 10 + 35 : Math.random() * 15 + 35; 
            
            bubbles.push({
                x: Math.random() * (canvasElement.width - radius * 2) + radius,
                y: -radius - 50,
                radius: radius,
                data: spawnedData,
                isTarget: isTargetObj,
                speedY: Math.random() * 3 + 3, 
                speedX: (Math.random() - 0.5) * 2,
                rotation: 0,
                rotSpeed: (Math.random() - 0.5) * 0.1
            });
        }

        function createParticles(x, y, color) {
            for(let i=0; i<20; i++){
                particles.push({
                    x: x, y: y, vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 0.5) * 20, life: 1.0, color: color
                });
            }
        }

        function showFloatingText(x, y, text, isPositive) {
            const el = document.createElement('div');
            el.className = `score-pop ${isPositive ? 'text-green-400' : 'text-red-500'}`;
            el.innerText = text;
            const mirroredX = window.innerWidth - x; 
            el.style.left = `${mirroredX - 25}px`;
            el.style.top = `${y - 25}px`;
            document.getElementById('ui-layer').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function updateScoreDisplay() {
            scoreDisplay.innerText = score;
            if(score < 0) scoreDisplay.classList.add('text-red-400');
            else scoreDisplay.classList.remove('text-red-400');
        }

        // --- MEDIA PIPE (AI TANGAN) ---
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        hands.onResults((results) => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            
            // Gambar Video Kamera
            if (results.image) {
                const videoRatio = results.image.width / results.image.height;
                const canvasRatio = canvasElement.width / canvasElement.height;
                let drawWidth, drawHeight, startX, startY;

                if (canvasRatio > videoRatio) {
                    drawWidth = canvasElement.width;
                    drawHeight = canvasElement.width / videoRatio;
                    startX = 0; startY = (canvasElement.height - drawHeight) / 2;
                } else {
                    drawHeight = canvasElement.height;
                    drawWidth = canvasElement.height * videoRatio;
                    startX = (canvasElement.width - drawWidth) / 2; startY = 0;
                }
                canvasCtx.drawImage(results.image, startX, startY, drawWidth, drawHeight);
                
                indexFingerTips = [];
                if (results.multiHandLandmarks) {
                    results.multiHandLandmarks.forEach((landmarks) => {
                        const indexTip = landmarks[8];
                        indexFingerTips.push({ x: (indexTip.x * drawWidth) + startX, y: (indexTip.y * drawHeight) + startY });
                    });
                }
            }
            canvasCtx.restore();

            if (isGameRunning) updateAndDrawGame();
            else if (loadingText.style.display === 'block') startGamePlay();
        });

        const camera = new Camera(videoElement, { onFrame: async () => { await hands.send({image: videoElement}); }, width: 1280, height: 720 });

        // --- RENDER UTAMA (Dipanggil oleh MediaPipe Loop) ---
        function updateAndDrawGame() {
            const now = performance.now();
            const dt = (now - lastFrameTime) / 1000;
            lastFrameTime = now;

            timeRemaining -= dt;
            if (timeRemaining <= 0) { timeRemaining = 0; showGameOverScreen(); return; }
            
            timerDisplay.innerText = formatTime(timeRemaining);
            if (timeRemaining < 10) {
                timerBox.classList.add('border-red-500');
                timerDisplay.classList.add('text-red-500');
                timerDisplay.classList.remove('text-yellow-400');
            }

            spawnTimer += dt;
            if (spawnTimer > 0.8) { spawnBubble(); spawnTimer = 0; }

            // Update & Gambar Bubble
            for (let i = bubbles.length - 1; i >= 0; i--) {
                let b = bubbles[i];
                b.y += b.speedY;
                b.x += b.speedX;
                b.rotation += b.rotSpeed;

                if (b.x < b.radius || b.x > canvasElement.width - b.radius) b.speedX *= -1;

                let isTouched = false;
                for (let pointer of indexFingerTips) {
                    if (Math.hypot(pointer.x - b.x, pointer.y - b.y) < b.radius + 15) { isTouched = true; break; }
                }

                if (isTouched) {
                    if (b.isTarget) {
                        playCorrectSound(); // Mainkan Suara Sorakan/Benar
                        score += 10;
                        showFloatingText(b.x, b.y, "+10", true);
                        createParticles(b.x, b.y, currentMode === 'warna' ? b.data.hex : '#4ade80');
                    } else {
                        playWrongSound(); // Mainkan Suara Ledakan/Salah
                        score -= 10;
                        showFloatingText(b.x, b.y, "-10", false);
                        createParticles(b.x, b.y, '#ef4444'); 
                        canvasCtx.fillStyle = 'rgba(255, 0, 0, 0.4)'; 
                        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
                    }
                    
                    updateScoreDisplay();
                    bubbles.splice(i, 1);
                    continue;
                }

                if (b.y > canvasElement.height + b.radius) { bubbles.splice(i, 1); continue; }

                // RENDER BUBBLE / OBJEK
                canvasCtx.save();
                canvasCtx.translate(b.x, b.y);
                canvasCtx.rotate(b.rotation);
                
                if (currentMode === 'warna') {
                    // Render Bola Warna Solid
                    canvasCtx.beginPath();
                    canvasCtx.arc(0, 0, b.radius, 0, Math.PI * 2);
                    canvasCtx.fillStyle = b.data.hex;
                    canvasCtx.fill();
                    canvasCtx.lineWidth = 4;
                    canvasCtx.strokeStyle = '#ffffff';
                    canvasCtx.stroke();
                    
                    // Highlight Kaca Bola
                    canvasCtx.beginPath();
                    canvasCtx.arc(-b.radius*0.3, -b.radius*0.3, b.radius*0.3, 0, Math.PI * 2);
                    canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                    canvasCtx.fill();
                } else {
                    // Render Gelembung Sabun dengan Teks (Huruf/Angka)
                    canvasCtx.beginPath();
                    canvasCtx.arc(0, 0, b.radius, 0, Math.PI * 2);
                    canvasCtx.fillStyle = 'rgba(30, 64, 175, 0.6)';
                    canvasCtx.fill();
                    canvasCtx.lineWidth = 3;
                    canvasCtx.strokeStyle = 'rgba(96, 165, 250, 0.9)';
                    canvasCtx.stroke();
                    
                    canvasCtx.beginPath();
                    canvasCtx.arc(-b.radius*0.3, -b.radius*0.3, b.radius*0.3, 0, Math.PI * 2);
                    canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    canvasCtx.fill();

                    // Teks dalam gelembung
                    canvasCtx.scale(-1, 1); // Anti-mirror untuk teks
                    canvasCtx.fillStyle = '#ffffff';
                    canvasCtx.font = `bold ${b.radius}px 'Segoe UI', Arial`;
                    canvasCtx.textAlign = 'center';
                    canvasCtx.textBaseline = 'middle';
                    canvasCtx.shadowColor = 'rgba(0,0,0,0.8)';
                    canvasCtx.shadowBlur = 5;
                    canvasCtx.fillText(b.data, 0, 0);
                }
                canvasCtx.restore();
            }

            // Render Partikel
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= dt * 3.0; 
                if (p.life <= 0) { particles.splice(i, 1); continue; }
                canvasCtx.globalAlpha = p.life;
                canvasCtx.beginPath();
                canvasCtx.arc(p.x, p.y, 6, 0, Math.PI * 2);
                canvasCtx.fillStyle = p.color;
                canvasCtx.fill();
            }
            canvasCtx.globalAlpha = 1.0;

            // Indikator Jari
            for (let pointer of indexFingerTips) {
                canvasCtx.beginPath();
                canvasCtx.arc(pointer.x, pointer.y, 18, 0, Math.PI * 2);
                canvasCtx.fillStyle = 'rgba(56, 189, 248, 0.6)';
                canvasCtx.fill();
                canvasCtx.lineWidth = 3;
                canvasCtx.strokeStyle = '#ffffff';
                canvasCtx.stroke();
                
                canvasCtx.beginPath();
                canvasCtx.arc(pointer.x, pointer.y, 4, 0, Math.PI * 2);
                canvasCtx.fillStyle = '#ffffff';
                canvasCtx.fill();
            }
        }
    </script>
</body>
</html>
