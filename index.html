<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Kamera: Tangkap Bola</title>
    
    <!-- Tailwind CSS untuk styling UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google MediaPipe untuk Pelacakan Tangan -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        
        #webcam { display: none; }
        
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            transform: scaleX(-1); /* Cermin */
            object-fit: cover;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
        
        .score-pop {
            position: absolute;
            font-weight: bold;
            font-size: 2.5rem;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
            z-index: 20;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }
        
        /* Mencegah seleksi teks saat bermain */
        .no-select { user-select: none; -webkit-user-select: none; }
    </style>
</head>
<body>

    <!-- UI Layer -->
    <div id="ui-layer" class="flex flex-col justify-center items-center no-select">
        
        <!-- Menu Mulai -->
        <div id="start-menu" class="pointer-events-auto bg-gray-900 bg-opacity-90 p-8 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-md w-full mx-4 transition-all duration-500">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 mb-2">
                TANGKAP BOLA
            </h1>
            <p class="text-gray-400 text-sm mb-6 uppercase tracking-widest font-semibold">Kamera Interaktif</p>
            
            <div class="text-left text-gray-300 mb-6 space-y-2 text-sm bg-gray-800 p-4 rounded-xl">
                <p>üéØ Sentuh bola <span class="text-green-400 font-bold">HIJAU (+10)</span></p>
                <p>‚ò†Ô∏è Hindari bola <span class="text-red-500 font-bold">MERAH (-10)</span></p>
                <p>ü§è Tekuk jari telunjuk ke jempol untuk efek klik.</p>
                <p>‚úåÔ∏è Angkat 2 jari (telunjuk & tengah) untuk menyembunyikan kursor.</p>
            </div>

            <button id="start-btn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold py-4 px-6 rounded-2xl shadow-[0_0_15px_rgba(59,130,246,0.5)] transition-all transform hover:scale-105 active:scale-95 text-xl">
                Mulai (Layar Penuh)
            </button>
            <p id="loading-text" class="text-yellow-400 mt-4 text-sm hidden font-semibold animate-pulse">
                Menghidupkan Kamera & AI...
            </p>
        </div>

        <!-- HUD: Skor & Indikator -->
        <div id="hud" class="absolute top-0 left-0 w-full p-4 flex justify-between items-start hidden">
            <div class="bg-gray-900 bg-opacity-75 backdrop-blur-md rounded-2xl p-4 border border-gray-700 shadow-lg min-w-[120px] text-center">
                <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">SKOR</p>
                <p id="score-display" class="text-5xl font-black text-white transition-colors duration-300">0</p>
            </div>
            
            <div class="flex flex-col gap-2">
                <button onclick="exitFullscreenAndReload()" class="bg-red-500 bg-opacity-80 text-white text-sm font-bold px-4 py-2 rounded-xl pointer-events-auto hover:bg-red-600 shadow-lg backdrop-blur-md transition-transform hover:scale-105">
                    Akhiri Game
                </button>
            </div>
        </div>
    </div>

    <video id="webcam" autoplay playsinline></video>
    <canvas id="game-canvas"></canvas>

    <script>
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('game-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        const startMenu = document.getElementById('start-menu');
        const startBtn = document.getElementById('start-btn');
        const loadingText = document.getElementById('loading-text');
        const hud = document.getElementById('hud');
        const scoreDisplay = document.getElementById('score-display');
        
        let isGameRunning = false;
        let score = 0;
        let balls = [];
        let particles = [];
        let indexFingerTips = []; 
        let clickRipples = []; 
        let handClickStates = {}; 
        let lastFrameTime = performance.now();
        let spawnTimer = 0;

        function resizeCanvas() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- FUNGSI FULLSCREEN ---
        function requestFullScreen() {
            const docElm = document.documentElement;
            if (docElm.requestFullscreen) {
                docElm.requestFullscreen();
            } else if (docElm.mozRequestFullScreen) { // Firefox
                docElm.mozRequestFullScreen();
            } else if (docElm.webkitRequestFullScreen) { // Chrome, Safari, Opera
                docElm.webkitRequestFullScreen();
            } else if (docElm.msRequestFullscreen) { // IE/Edge
                docElm.msRequestFullscreen();
            }
        }

        function exitFullscreenAndReload() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
            setTimeout(() => location.reload(), 300); // Reload setelah keluar fullscreen
        }

        // --- MEDIA PIPE ---
        const hands = new Hands({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        
        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults((results) => {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            // Menggambar video menutupi layar tanpa merusak aspect ratio
            const videoRatio = results.image.width / results.image.height;
            const canvasRatio = canvasElement.width / canvasElement.height;
            let drawWidth, drawHeight, startX, startY;

            if (canvasRatio > videoRatio) {
                drawWidth = canvasElement.width;
                drawHeight = canvasElement.width / videoRatio;
                startX = 0;
                startY = (canvasElement.height - drawHeight) / 2;
            } else {
                drawHeight = canvasElement.height;
                drawWidth = canvasElement.height * videoRatio;
                startX = (canvasElement.width - drawWidth) / 2;
                startY = 0;
            }
            canvasCtx.drawImage(results.image, startX, startY, drawWidth, drawHeight);
            canvasCtx.restore();

            indexFingerTips = [];
            if (results.multiHandLandmarks) {
                results.multiHandLandmarks.forEach((landmarks, index) => {
                    const indexTip = landmarks[8];
                    const indexPIP = landmarks[6];
                    const middleTip = landmarks[12];
                    const middlePIP = landmarks[10];
                    const thumbTip = landmarks[4];

                    // Deteksi "Dua Jari Diangkat" (V sign / Peace)
                    const isIndexRaised = indexTip.y < indexPIP.y;
                    const isMiddleRaised = middleTip.y < middlePIP.y;

                    if (isIndexRaised && isMiddleRaised) {
                        handClickStates[index] = false;
                        return; // Sembunyikan pointer
                    }

                    // Deteksi "Klik" (Pinch)
                    const distPinch = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
                    const isClicking = distPinch < 0.06;

                    // Hitung koordinat relatif terhadap gambar video yang sudah di-scaling
                    let actualX = (indexTip.x * drawWidth) + startX;
                    let actualY = (indexTip.y * drawHeight) + startY;

                    indexFingerTips.push({
                        x: actualX,
                        y: actualY,
                        isClicking: isClicking,
                        handIndex: index
                    });
                });
            }

            if (isGameRunning) {
                updateAndDrawGame();
            } else if (loadingText.style.display !== 'none') {
                startGame();
            }
        });

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });

        // --- KONTROL TOMBOL MULAI ---
        startBtn.addEventListener('click', () => {
            // Minta Fullscreen saat tombol ditekan!
            requestFullScreen();
            
            startBtn.style.display = 'none';
            loadingText.style.display = 'block';
            camera.start().catch(err => {
                alert("Gagal mengakses kamera. Pastikan memberikan izin!");
                startBtn.style.display = 'block';
                loadingText.style.display = 'none';
            });
        });

        function startGame() {
            startMenu.style.opacity = '0';
            setTimeout(() => {
                startMenu.style.display = 'none';
                hud.style.display = 'flex';
                isGameRunning = true;
                score = 0;
                updateScoreDisplay();
                lastFrameTime = performance.now();
            }, 500);
        }

        // --- LOGIKA GAME ---
        function spawnBall() {
            const isRed = Math.random() < 0.35; 
            const radius = isRed ? Math.random() * 15 + 25 : Math.random() * 20 + 35; 
            balls.push({
                x: Math.random() * (canvasElement.width - radius * 2) + radius,
                y: -radius - 50,
                radius: radius,
                type: isRed ? 'bad' : 'good',
                color: isRed ? '#ef4444' : '#4ade80',
                speedY: Math.random() * 4 + 4, // Kecepatan sedikit dinaikkan
                speedX: (Math.random() - 0.5) * 2,
                rotation: 0,
                rotSpeed: (Math.random() - 0.5) * 0.2
            });
        }

        function createParticles(x, y, color) {
            for(let i=0; i<20; i++){
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 15,
                    vy: (Math.random() - 0.5) * 15,
                    life: 1.0,
                    color: color
                });
            }
        }

        function showFloatingText(x, y, text, isPositive) {
            const el = document.createElement('div');
            el.className = `score-pop ${isPositive ? 'text-green-400' : 'text-red-500'}`;
            el.innerText = text;
            const mirroredX = window.innerWidth - x; 
            
            el.style.left = `${mirroredX - 25}px`;
            el.style.top = `${y - 25}px`;
            document.getElementById('ui-layer').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function updateScoreDisplay() {
            scoreDisplay.innerText = score;
            if(score < 0) scoreDisplay.classList.add('text-red-500');
            else scoreDisplay.classList.remove('text-red-500');
        }

        function updateAndDrawGame() {
            const now = performance.now();
            const dt = (now - lastFrameTime) / 1000;
            lastFrameTime = now;

            spawnTimer += dt;
            if (spawnTimer > 0.7) { 
                spawnBall();
                spawnTimer = 0;
            }

            // Gambar & Update Bola
            for (let i = balls.length - 1; i >= 0; i--) {
                let b = balls[i];
                b.y += b.speedY;
                b.x += b.speedX;
                b.rotation += b.rotSpeed;

                if (b.x < b.radius || b.x > canvasElement.width - b.radius) b.speedX *= -1;

                let isTouched = false;
                for (let pointer of indexFingerTips) {
                    const dist = Math.hypot(pointer.x - b.x, pointer.y - b.y);
                    if (dist < b.radius + 15) { 
                        isTouched = true;
                        break;
                    }
                }

                if (isTouched) {
                    if (b.type === 'good') {
                        score += 10;
                        showFloatingText(b.x, b.y, "+10", true);
                    } else {
                        score -= 10;
                        showFloatingText(b.x, b.y, "-10", false);
                        canvasCtx.fillStyle = 'rgba(255, 0, 0, 0.4)';
                        canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
                    }
                    
                    updateScoreDisplay();
                    createParticles(b.x, b.y, b.color);
                    balls.splice(i, 1);
                    continue;
                }

                if (b.y > canvasElement.height + b.radius) {
                    balls.splice(i, 1);
                    continue;
                }

                // Desain Bola yang lebih baik
                canvasCtx.save();
                canvasCtx.translate(b.x, b.y);
                canvasCtx.rotate(b.rotation);
                
                canvasCtx.beginPath();
                canvasCtx.arc(0, 0, b.radius, 0, Math.PI * 2);
                canvasCtx.fillStyle = b.color;
                canvasCtx.shadowColor = b.color;
                canvasCtx.shadowBlur = 15;
                canvasCtx.fill();
                
                canvasCtx.lineWidth = 3;
                canvasCtx.strokeStyle = '#ffffff';
                canvasCtx.stroke();
                
                canvasCtx.beginPath();
                canvasCtx.arc(-b.radius*0.3, -b.radius*0.3, b.radius*0.2, 0, Math.PI * 2);
                canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                canvasCtx.shadowBlur = 0;
                canvasCtx.fill();
                canvasCtx.restore();
            }

            // Partikel
            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= dt * 2.5; 

                if (p.life <= 0) {
                    particles.splice(i, 1);
                    continue;
                }

                canvasCtx.globalAlpha = p.life;
                canvasCtx.beginPath();
                canvasCtx.arc(p.x, p.y, 5, 0, Math.PI * 2);
                canvasCtx.fillStyle = p.color;
                canvasCtx.fill();
            }
            canvasCtx.globalAlpha = 1.0;

            // Indikator Jari & Efek Ripple Klik
            for (let pointer of indexFingerTips) {
                if (pointer.isClicking && !handClickStates[pointer.handIndex]) {
                    clickRipples.push({ x: pointer.x, y: pointer.y, radius: 15, alpha: 1.0 });
                    handClickStates[pointer.handIndex] = true;
                } else if (!pointer.isClicking) {
                    handClickStates[pointer.handIndex] = false;
                }

                canvasCtx.beginPath();
                canvasCtx.arc(pointer.x, pointer.y, 18, 0, Math.PI * 2);
                canvasCtx.fillStyle = pointer.isClicking ? 'rgba(255, 255, 255, 0.9)' : 'rgba(56, 189, 248, 0.6)';
                canvasCtx.shadowColor = pointer.isClicking ? '#ffffff' : '#38bdf8';
                canvasCtx.shadowBlur = 20;
                canvasCtx.fill();
                canvasCtx.lineWidth = 3;
                canvasCtx.strokeStyle = '#ffffff';
                canvasCtx.stroke();
                canvasCtx.shadowBlur = 0; // Reset
            }

            // Animasi Gelombang (Ripple)
            for (let i = clickRipples.length - 1; i >= 0; i--) {
                let r = clickRipples[i];
                r.radius += dt * 300; 
                r.alpha -= dt * 2.5;  

                if (r.alpha <= 0) {
                    clickRipples.splice(i, 1);
                    continue;
                }

                canvasCtx.beginPath();
                canvasCtx.arc(r.x, r.y, r.radius, 0, Math.PI * 2);
                canvasCtx.strokeStyle = `rgba(255, 255, 255, ${r.alpha})`;
                canvasCtx.lineWidth = 5 * r.alpha;
                canvasCtx.stroke();
            }
        }
    </script>
</body>
</html>
