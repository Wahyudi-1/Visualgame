<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Kamera: Tangkap Objek</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #111; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        
        /* PERBAIKAN BUG KAMERA: Video dilempar jauh dari layar tetapi ukurannya dipertahankan agar browser tidak membekukannya (Throttling) */
        #webcam { position: absolute; left: -10000px; top: -10000px; width: 640px; height: 480px; pointer-events: none; }
        
        #game-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; transform: scaleX(-1); object-fit: cover; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
        
        .score-pop { position: absolute; font-weight: bold; font-size: 2.5rem; animation: floatUp 1s ease-out forwards; pointer-events: none; z-index: 20; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-50px) scale(1.5); } }
        
        .no-select { user-select: none; -webkit-user-select: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="ui-layer" class="flex flex-col justify-center items-center no-select">
        
        <!-- MENU UTAMA -->
        <div id="start-menu" class="pointer-events-auto bg-gray-900 bg-opacity-90 p-8 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-md w-full mx-4 transition-all duration-500">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400 mb-2">
                TANGKAP OBJEK
            </h1>
            <p class="text-gray-400 text-sm mb-6 uppercase tracking-widest font-semibold">Kamera Interaktif (Versi Ringan)</p>
            
            <div class="text-left text-gray-300 mb-6 space-y-2 text-sm bg-gray-800 p-4 rounded-xl">
                <p>‚è±Ô∏è Waktu Bermain: <span class="text-yellow-400 font-bold">Pilihan (0.5 - 5 Menit)</span>.</p>
                <p>üéØ Tangkap target yang benar untuk <span class="text-green-400 font-bold">+10 Poin</span>.</p>
                <p>üí• Hati-hati objek pengecoh! Salah sentuh <span class="text-red-500 font-bold">-10 Poin</span>.</p>
                <p>üëÜ <span class="text-blue-400 font-bold">Kontrol Jari:</span> Luruskan telunjuk untuk menangkap. Luruskan dua jari (‚úåÔ∏è) untuk menjeda kursor.</p>
            </div>

            <!-- Tombol Mulai (Memperbaiki tag penutup HTML sebelumnya yang rusak) -->
            <button id="start-btn" class="w-full bg-gradient-to-r from-blue-600 to-green-600 hover:from-blue-500 hover:to-green-500 text-white font-bold py-4 px-6 rounded-2xl shadow-[0_0_15px_rgba(59,130,246,0.5)] transition-all transform hover:scale-105 active:scale-95 text-xl mb-4">
                Mulai (Layar Penuh)
            </button>

            <!-- Keterangan Pembuat -->
            <div class="mt-4 pt-4 border-t border-gray-700 text-sm text-gray-400">
                <p>Dibuat oleh <span class="font-bold text-gray-200">Wahyudi</span> dengan menggunakan <span class="font-bold text-gray-200">Gemini AI</span></p>
                <a href="https://wa.me/6281336578058" target="_blank" rel="noopener noreferrer" class="mt-3 inline-flex items-center justify-center gap-2 bg-[#25D366] hover:bg-[#128C7E] text-white font-bold py-2 px-4 rounded-xl transition-all shadow-lg transform hover:scale-105 pointer-events-auto">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    0813-3657-8058
                </a>
            </div>
        </div>

        <!-- MENU PILIH WAKTU -->
        <div id="time-selection" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-6 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-lg w-full mx-4 transition-all duration-500 flex-col">
            <h2 class="text-2xl font-bold text-white mb-2">Pilih Waktu Bermain</h2>
            <p class="text-gray-400 text-sm mb-6">Berapa lama Anda ingin bermain?</p>
            
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 mb-4">
                <button onclick="selectTime(30)" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg">0.5 Menit</button>
                <button onclick="selectTime(60)" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg">1 Menit</button>
                <button onclick="selectTime(120)" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg">2 Menit</button>
                <button onclick="selectTime(180)" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg">3 Menit</button>
                <button onclick="selectTime(240)" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg">4 Menit</button>
                <button onclick="selectTime(300)" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg">5 Menit</button>
            </div>
            <button onclick="backToStartMenu()" class="mt-2 text-gray-400 hover:text-white text-sm underline pb-2">Kembali ke Menu Utama</button>
        </div>

        <!-- MENU PILIH MODE -->
        <div id="mode-selection" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-6 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-lg w-full mx-4 transition-all duration-500 flex-col">
            <h2 class="text-2xl font-bold text-white mb-2">Pilih Mode Permainan</h2>
            <p class="text-gray-400 text-sm mb-6">Apa yang ingin Anda tangkap hari ini?</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <button onclick="selectMode('huruf')" class="bg-gradient-to-r from-indigo-500 to-blue-600 hover:from-indigo-400 hover:to-blue-500 text-white font-bold py-4 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg flex flex-col items-center justify-center gap-2">
                    <span>üî§ Huruf A - Z</span>
                    <span class="text-xs bg-black bg-opacity-30 px-3 py-1 rounded-full">Besar & Kecil</span>
                </button>
                <button onclick="selectMode('angka')" class="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 text-white font-bold py-4 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg flex flex-col items-center justify-center gap-2">
                    <span>üî¢ Angka 0 - 30</span>
                    <span class="text-xs bg-black bg-opacity-30 px-3 py-1 rounded-full">Dasar</span>
                </button>
                <button onclick="selectMode('warna')" class="bg-gradient-to-r from-rose-500 to-orange-500 hover:from-rose-400 hover:to-orange-400 text-white font-bold py-4 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg flex flex-col items-center justify-center gap-2">
                    <span>üé® Aneka Warna</span>
                    <span class="text-xs bg-black bg-opacity-30 px-3 py-1 rounded-full">Visual</span>
                </button>
                <button onclick="openMathMenu()" class="bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-white font-bold py-4 px-4 rounded-xl text-lg transition-transform hover:scale-105 shadow-lg flex flex-col items-center justify-center gap-2">
                    <span>üßÆ Matematika</span>
                    <span class="text-xs bg-black bg-opacity-30 px-3 py-1 rounded-full">Operasi Hitung</span>
                </button>
            </div>
            <button onclick="backToTimeSelection()" class="mt-2 text-gray-400 hover:text-white text-sm underline pb-2">Kembali Pilih Waktu</button>
        </div>

        <!-- MENU PILIH MATEMATIKA -->
        <div id="math-selection" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-6 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-lg w-full mx-4 transition-all duration-500 flex-col">
            <h2 class="text-2xl font-bold text-white mb-2">Pilih Operasi Hitung</h2>
            <p class="text-gray-400 text-sm mb-6">Pecahkan soal untuk menangkap target!</p>
            
            <div id="math-grid" class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="selectMathMode('math_add_1')" class="bg-gray-800 border border-gray-600 hover:bg-blue-600 hover:border-blue-400 text-white font-bold py-3 px-2 rounded-xl transition-all shadow-sm transform hover:scale-105 active:scale-95 flex flex-col items-center text-sm">
                    <span class="text-xl mb-1">‚ûï</span> Penjumlahan 1 Digit
                </button>
                <button onclick="selectMathMode('math_add_2')" class="bg-gray-800 border border-gray-600 hover:bg-blue-600 hover:border-blue-400 text-white font-bold py-3 px-2 rounded-xl transition-all shadow-sm transform hover:scale-105 active:scale-95 flex flex-col items-center text-sm">
                    <span class="text-xl mb-1">‚ûï</span> Penjumlahan 2 Digit
                </button>
                <button onclick="selectMathMode('math_sub_1')" class="bg-gray-800 border border-gray-600 hover:bg-red-600 hover:border-red-400 text-white font-bold py-3 px-2 rounded-xl transition-all shadow-sm transform hover:scale-105 active:scale-95 flex flex-col items-center text-sm">
                    <span class="text-xl mb-1">‚ûñ</span> Pengurangan 1 Digit
                </button>
                <button onclick="selectMathMode('math_sub_2')" class="bg-gray-800 border border-gray-600 hover:bg-red-600 hover:border-red-400 text-white font-bold py-3 px-2 rounded-xl transition-all shadow-sm transform hover:scale-105 active:scale-95 flex flex-col items-center text-sm">
                    <span class="text-xl mb-1">‚ûñ</span> Pengurangan 2 Digit
                </button>
                <button onclick="selectMathMode('math_mul_1')" class="bg-gray-800 border border-gray-600 hover:bg-purple-600 hover:border-purple-400 text-white font-bold py-3 px-2 rounded-xl transition-all shadow-sm transform hover:scale-105 active:scale-95 flex flex-col items-center text-sm">
                    <span class="text-xl mb-1">‚úñÔ∏è</span> Perkalian 1 Digit
                </button>
                <button onclick="selectMathMode('math_div')" class="bg-gray-800 border border-gray-600 hover:bg-green-600 hover:border-green-400 text-white font-bold py-3 px-2 rounded-xl transition-all shadow-sm transform hover:scale-105 active:scale-95 flex flex-col items-center text-sm">
                    <span class="text-xl mb-1">‚ûó</span> Pembagian Bulat
                </button>
            </div>
            <button onclick="backToModeSelectionFromMath()" id="math-back-btn" class="mt-2 text-gray-400 hover:text-white text-sm underline pb-2">Kembali Pilih Mode</button>
            <p id="math-loading-text" class="text-yellow-400 mt-2 text-sm hidden font-semibold animate-pulse">Menghidupkan Kamera & AI (Mohon tunggu)...</p>
        </div>

        <!-- MENU PILIH TARGET -->
        <div id="target-selection" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-6 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-xl w-full mx-4 transition-all duration-500 max-h-[90vh] flex-col">
            <h2 id="target-title" class="text-2xl font-bold text-white mb-2">Pilih Target Anda</h2>
            <p class="text-gray-400 text-sm mb-4">Pilih satu target utama untuk ditangkap.</p>
            
            <div id="target-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-3 overflow-y-auto custom-scrollbar p-2 mb-4 max-h-[60vh]"></div>

            <button onclick="backToModeSelection()" id="back-btn" class="mt-2 text-gray-400 hover:text-white text-sm underline pb-2">Kembali Pilih Mode</button>
            <p id="loading-text" class="text-yellow-400 mt-2 text-sm hidden font-semibold animate-pulse">Menghidupkan Kamera & AI (Mohon tunggu)...</p>
        </div>

        <!-- HUD GAME -->
        <div id="hud" class="absolute top-0 left-0 w-full p-4 flex justify-between items-start hidden pointer-events-none">
            <div class="flex gap-4">
                <div class="bg-blue-900 bg-opacity-80 backdrop-blur-md rounded-2xl p-4 border border-blue-500 shadow-lg min-w-[100px] text-center flex flex-col items-center justify-center">
                    <p class="text-blue-200 text-[10px] font-bold uppercase tracking-widest mb-1">TARGET</p>
                    <div id="target-display" class="text-3xl font-black text-white">A</div>
                </div>
                <div class="bg-gray-900 bg-opacity-75 backdrop-blur-md rounded-2xl p-4 border border-gray-700 shadow-lg min-w-[100px] text-center">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">SKOR</p>
                    <p id="score-display" class="text-4xl font-black text-white transition-colors duration-300">0</p>
                </div>
            </div>
            
            <div class="flex flex-col gap-2 items-end">
                <div id="timer-box" class="bg-gray-900 bg-opacity-75 backdrop-blur-md rounded-2xl p-3 border border-gray-700 shadow-lg min-w-[100px] text-center">
                    <p class="text-gray-400 text-[10px] font-bold uppercase tracking-widest mb-1">WAKTU</p>
                    <p id="timer-display" class="text-3xl font-mono font-bold text-yellow-400">03:00</p>
                </div>
                <button onclick="exitFullscreenAndReload()" class="bg-red-500 bg-opacity-80 text-white text-xs font-bold px-3 py-2 rounded-xl pointer-events-auto hover:bg-red-600 shadow-lg backdrop-blur-md transition-transform hover:scale-105 mt-1">Akhiri Game</button>
            </div>
        </div>

        <!-- GAME OVER -->
        <div id="game-over" class="hidden pointer-events-auto bg-gray-900 bg-opacity-95 p-8 rounded-3xl shadow-2xl text-center backdrop-blur-md border border-gray-700 max-w-md w-full mx-4 transform scale-105">
            <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500 mb-2">WAKTU HABIS!</h1>
            <p class="text-gray-300 mb-6 text-lg">Permainan Selesai.</p>
            
            <div class="bg-gray-800 p-6 rounded-2xl mb-6 border border-gray-700">
                <p class="text-gray-400 text-sm uppercase tracking-widest mb-2">Skor Akhir Anda</p>
                <p id="final-score" class="text-6xl font-black text-white">0</p>
            </div>

            <button onclick="exitFullscreenAndReload()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transition-all transform hover:scale-105 active:scale-95 text-xl">Main Lagi</button>
        </div>

    </div>

    <!-- Elemen Media -->
    <video id="webcam" autoplay playsinline></video>
    <canvas id="game-canvas"></canvas>

    <script>
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('game-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        
        const startMenu = document.getElementById('start-menu');
        const timeSelectionMenu = document.getElementById('time-selection');
        const modeSelectionMenu = document.getElementById('mode-selection');
        const mathSelectionMenu = document.getElementById('math-selection');
        const targetSelectionMenu = document.getElementById('target-selection');
        const targetGrid = document.getElementById('target-grid');
        const loadingText = document.getElementById('loading-text');
        const mathLoadingText = document.getElementById('math-loading-text');
        
        const hud = document.getElementById('hud');
        const scoreDisplay = document.getElementById('score-display');
        const targetDisplay = document.getElementById('target-display');
        const timerDisplay = document.getElementById('timer-display');
        const timerBox = document.getElementById('timer-box');
        const gameOverScreen = document.getElementById('game-over');
        const finalScoreDisplay = document.getElementById('final-score');
        const backBtn = document.getElementById('back-btn');

        // AUDIO
        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playCorrectSound() {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination); osc.type = 'sine'; const now = audioCtx.currentTime;
            osc.frequency.setValueAtTime(523.25, now); osc.frequency.setValueAtTime(659.25, now + 0.1); osc.frequency.setValueAtTime(783.99, now + 0.2);
            gainNode.gain.setValueAtTime(0, now); gainNode.gain.linearRampToValueAtTime(0.3, now + 0.05); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.start(now); osc.stop(now + 0.4);
        }

        function playWrongSound() {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain();
            osc.connect(gainNode); gainNode.connect(audioCtx.destination); osc.type = 'square'; const now = audioCtx.currentTime;
            osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(30, now + 0.3);
            gainNode.gain.setValueAtTime(0.5, now); gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.start(now); osc.stop(now + 0.4);
        }

        // DATA
        const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split('');
        const NUMBERS = Array.from({length: 31}, (_, i) => i.toString());
        const COLORS = [
            { id: 'Merah', hex: '#ef4444' }, { id: 'Biru', hex: '#3b82f6' }, { id: 'Hijau', hex: '#22c55e' }, { id: 'Kuning', hex: '#eab308' },
            { id: 'Ungu', hex: '#a855f7' }, { id: 'Oranye', hex: '#f97316' }, { id: 'Pink', hex: '#ec4899' }, { id: 'Putih', hex: '#ffffff' },
            { id: 'Abu-abu', hex: '#6b7280' }, { id: 'Coklat', hex: '#78350f' }
        ];

        let currentMode = ''; let isGameRunning = false; let score = 0; let targetData = null; let timeRemaining = 180; let selectedTime = 180;
        let bubbles = []; let particles = []; let indexFingerTips = []; 
        let lastFrameTime = performance.now(); let spawnTimer = 0;
        let handsReady = false; let isWaitingForCamera = false;

        // FUNGSI PERBAIKAN: Menampilkan Skor HUD
        function updateScoreDisplay() {
            scoreDisplay.innerText = score;
            if (score < 0) {
                scoreDisplay.classList.add('text-red-500');
                scoreDisplay.classList.remove('text-white');
            } else {
                scoreDisplay.classList.add('text-white');
                scoreDisplay.classList.remove('text-red-500');
            }
        }

        // FUNGSI PERBAIKAN: Efek Partikel saat Menyentuh Objek
        function createParticles(x, y, color) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x: x, 
                    y: y, 
                    vx: (Math.random() - 0.5) * 12, 
                    vy: (Math.random() - 0.5) * 12, 
                    life: 1.0, 
                    color: color
                });
            }
        }

        // FUNGSI PERBAIKAN: Teks Melayang "+10" / "-10"
        function showFloatingText(x, y, text, isPositive) {
            const el = document.createElement('div');
            el.className = 'score-pop';
            el.innerText = text;
            el.style.color = isPositive ? '#4ade80' : '#ef4444';
            
            // Perhitungan kompensasi khusus karena canvas HTML terbalik efek cermin (scaleX(-1))
            const visualX = window.innerWidth - x;
            
            el.style.left = `${visualX - 25}px`;
            el.style.top = `${y - 20}px`;
            document.getElementById('ui-layer').appendChild(el);
            
            // Hapus elemen saat animasi selesai
            setTimeout(() => {
                if(el.parentNode) el.parentNode.removeChild(el);
            }, 1000);
        }

        function resizeCanvas() { canvasElement.width = window.innerWidth; canvasElement.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas); resizeCanvas();

        function requestFullScreen() {
            const docElm = document.documentElement;
            if (docElm.requestFullscreen) docElm.requestFullscreen();
            else if (docElm.mozRequestFullScreen) docElm.mozRequestFullScreen();
            else if (docElm.webkitRequestFullScreen) docElm.webkitRequestFullScreen();
        }
        function exitFullscreenAndReload() {
            if (document.exitFullscreen) document.exitFullscreen();
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
            setTimeout(() => location.reload(), 300);
        }

        // NAVIGATION
        document.getElementById('start-btn').addEventListener('click', () => {
            initAudio(); requestFullScreen();
            startMenu.style.display = 'none'; timeSelectionMenu.style.display = 'flex';
        });

        function selectTime(seconds) {
            initAudio(); selectedTime = seconds;
            timeSelectionMenu.style.display = 'none'; modeSelectionMenu.style.display = 'flex';
        }

        // Perbaikan animasi Menu saat kembali
        function backToStartMenu() { timeSelectionMenu.style.display = 'none'; startMenu.style.display = 'block'; }
        function backToTimeSelection() { modeSelectionMenu.style.display = 'none'; timeSelectionMenu.style.display = 'flex'; }

        function openMathMenu() {
            initAudio();
            modeSelectionMenu.style.display = 'none'; mathSelectionMenu.style.display = 'flex';
        }
        function backToModeSelectionFromMath() {
            mathSelectionMenu.style.display = 'none'; modeSelectionMenu.style.display = 'flex';
        }

        function selectMode(mode) {
            initAudio(); currentMode = mode;
            modeSelectionMenu.style.display = 'none'; targetSelectionMenu.style.display = 'flex';
            const titleEl = document.getElementById('target-title');
            if(mode === 'huruf') titleEl.innerText = "Pilih Huruf Target";
            else if(mode === 'angka') titleEl.innerText = "Pilih Angka Target";
            else if(mode === 'warna') titleEl.innerText = "Pilih Warna Target";
            populateTargetGrid();
        }

        function backToModeSelection() { targetSelectionMenu.style.display = 'none'; modeSelectionMenu.style.display = 'flex'; }

        function populateTargetGrid() {
            targetGrid.innerHTML = ''; let items = [];
            if (currentMode === 'huruf') items = ALPHABET; else if (currentMode === 'angka') items = NUMBERS; else if (currentMode === 'warna') items = COLORS;
            targetGrid.className = `grid gap-3 overflow-y-auto custom-scrollbar p-2 mb-4 max-h-[60vh] ${currentMode === 'angka' ? 'grid-cols-5 sm:grid-cols-7' : 'grid-cols-4 sm:grid-cols-6'}`;

            items.forEach(item => {
                const btn = document.createElement('button');
                btn.className = "bg-gray-800 border border-gray-600 hover:bg-blue-600 hover:border-blue-400 text-white font-bold py-3 rounded-xl transition-all shadow-sm transform hover:scale-110 active:scale-95 flex flex-col items-center justify-center min-h-[60px]";
                if (currentMode === 'warna') {
                    btn.innerHTML = `<div class="w-8 h-8 rounded-full shadow-inner mb-1 border border-gray-400" style="background-color: ${item.hex}"></div><span class="text-[10px] uppercase">${item.id}</span>`;
                    btn.onclick = () => selectFinalTarget(item); 
                } else {
                    btn.innerText = item; btn.className += " text-xl"; btn.onclick = () => selectFinalTarget(item); 
                }
                targetGrid.appendChild(btn);
            });
        }

        function selectFinalTarget(target) {
            initAudio(); targetData = target;
            targetDisplay.innerHTML = '';
            if (currentMode === 'warna') { targetDisplay.innerHTML = `<div class="w-10 h-10 rounded-full shadow-lg border-2 border-white" style="background-color: ${target.hex}"></div>`; } 
            else { targetDisplay.innerText = target; }
            
            targetGrid.style.display = 'none'; backBtn.style.display = 'none';
            document.querySelector('#target-selection h2').innerText = "Mempersiapkan AI...";
            document.querySelector('#target-selection p').style.display = 'none';
            loadingText.style.display = 'block';
            isWaitingForCamera = true;

            camera.start().catch(err => { alert("Gagal mengakses kamera. Pastikan memberikan izin!"); location.reload(); });
        }

        function selectMathMode(mode) {
            initAudio(); currentMode = mode;
            document.getElementById('math-grid').style.display = 'none';
            document.getElementById('math-back-btn').style.display = 'none';
            document.querySelector('#math-selection h2').innerText = "Mempersiapkan AI...";
            document.querySelector('#math-selection p').style.display = 'none';
            mathLoadingText.style.display = 'block';
            isWaitingForCamera = true;

            camera.start().catch(err => { alert("Gagal mengakses kamera. Pastikan memberikan izin!"); location.reload(); });
        }

        function generateMathQuestion() {
            let a, b, ans, op;
            switch(currentMode) {
                case 'math_add_1':
                    a = Math.floor(Math.random() * 9) + 1; b = Math.floor(Math.random() * 9) + 1;
                    ans = a + b; op = '+'; break;
                case 'math_add_2':
                    a = Math.floor(Math.random() * 90) + 10; b = Math.floor(Math.random() * 90) + 10;
                    ans = a + b; op = '+'; break;
                case 'math_sub_1':
                    a = Math.floor(Math.random() * 9) + 1; b = Math.floor(Math.random() * a) + 1; 
                    if (b > a) b = a; // Mencegah hasil negatif
                    ans = a - b; op = '-'; break;
                case 'math_sub_2':
                    a = Math.floor(Math.random() * 90) + 10; b = Math.floor(Math.random() * 90) + 10;
                    if (b > a) { let temp = a; a = b; b = temp; } // Memastikan selalu bilangan positif/bulat
                    ans = a - b; op = '-'; break;
                case 'math_mul_1':
                    a = Math.floor(Math.random() * 9) + 1; b = Math.floor(Math.random() * 9) + 1;
                    ans = a * b; op = 'x'; break;
                case 'math_div':
                    b = Math.floor(Math.random() * 9) + 1; // Pembagi (1-9)
                    ans = Math.floor(Math.random() * 10) + 1; // Jawaban (1-10)
                    a = b * ans; // Angka yang dibagi (Otomatis menghasilkan 1 atau 2 digit)
                    op = ':'; break;
            }
            targetData = { text: `${a} ${op} ${b}`, answer: ans.toString() };
            targetDisplay.innerHTML = `<span class="text-2xl">${targetData.text}</span>`;
            
            // Mengubah jawaban target pada gelembung yang sudah melayang
            bubbles.forEach(b => { b.isTarget = (b.data === targetData.answer); });
        }

        function startGamePlay() {
            loadingText.style.display = 'none'; 
            mathLoadingText.style.display = 'none';
            targetSelectionMenu.style.display = 'none'; 
            mathSelectionMenu.style.display = 'none';
            hud.style.display = 'flex';
            
            if (currentMode.startsWith('math_')) {
                generateMathQuestion();
            }

            isGameRunning = true; score = 0; timeRemaining = selectedTime; bubbles = [];
            updateScoreDisplay(); lastFrameTime = performance.now();
        }

        function showGameOverScreen() {
            isGameRunning = false; hud.style.display = 'none'; gameOverScreen.style.display = 'block';
            finalScoreDisplay.innerText = score; if(score < 0) finalScoreDisplay.classList.replace('text-white', 'text-red-500');
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // SPAWNER GELEMBUNG
        function spawnBubble() {
            let isTargetObj = Math.random() < 0.35; let spawnedData;
            if (currentMode === 'huruf') {
                if (isTargetObj) { spawnedData = targetData; } 
                else { do { spawnedData = ALPHABET[Math.floor(Math.random() * ALPHABET.length)]; } while (spawnedData.toUpperCase() === targetData.toUpperCase()); }
                if (Math.random() < 0.5) spawnedData = spawnedData.toLowerCase(); 
            } 
            else if (currentMode === 'angka') {
                if (isTargetObj) { spawnedData = targetData; } 
                else { do { spawnedData = NUMBERS[Math.floor(Math.random() * NUMBERS.length)]; } while (spawnedData === targetData); }
            }
            else if (currentMode === 'warna') {
                if (isTargetObj) { spawnedData = targetData; } 
                else { do { spawnedData = COLORS[Math.floor(Math.random() * COLORS.length)]; } while (spawnedData.id === targetData.id); }
            }
            else if (currentMode.startsWith('math_')) {
                if (isTargetObj) { 
                    spawnedData = targetData.answer; 
                } 
                else { 
                    let offset;
                    do { offset = Math.floor(Math.random() * 11) - 5; } while (offset === 0);
                    let wrongAns = parseInt(targetData.answer) + offset;
                    if (wrongAns < 0 && !currentMode.includes('sub')) wrongAns = Math.abs(wrongAns);
                    spawnedData = wrongAns.toString(); 
                }
            }
            const radius = currentMode === 'warna' ? Math.random() * 10 + 35 : Math.random() * 15 + 35; 
            bubbles.push({
                x: Math.random() * (canvasElement.width - radius * 2) + radius, y: -radius - 50, radius: radius,
                data: spawnedData, isTarget: isTargetObj, speedY: Math.random() * 3 + 3, speedX: (Math.random() - 0.5) * 2, rotation: 0, rotSpeed: (Math.random() - 0.5) * 0.1
            });
        }

        // --- SISTEM PELACAKAN JARI TANGAN (HANDS AI) ---
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });

        hands.onResults((results) => {
            handsReady = true;
            
            // Pastikan gambar video ada dan berukuran valid
            if (results.image && results.image.width > 0) {
                const vW = results.image.width;
                const vH = results.image.height;
                const canvasRatio = canvasElement.width / canvasElement.height;
                const videoRatio = vW / vH;
                let drawWidth, drawHeight, startX, startY;

                // Matematika pemetaan presisi tinggi (cover object-fit)
                if (canvasRatio > videoRatio) { 
                    drawWidth = canvasElement.width; drawHeight = canvasElement.width / videoRatio; startX = 0; startY = (canvasElement.height - drawHeight) / 2; 
                } else { 
                    drawHeight = canvasElement.height; drawWidth = canvasElement.height * videoRatio; startX = (canvasElement.width - drawWidth) / 2; startY = 0; 
                }
                
                let newFingerTips = [];
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    results.multiHandLandmarks.forEach((landmarks) => {
                        // Titik Acuan MediaPipe
                        const wrist = landmarks[0];           // Pergelangan Tangan
                        const indexMCP = landmarks[5];         // Pangkal Telunjuk (Knuckle)
                        const indexTip = landmarks[8];         // Ujung Telunjuk
                        const middleMCP = landmarks[9];        // Pangkal Jari Tengah
                        const middleTip = landmarks[12];       // Ujung Jari Tengah
                        const ringMCP = landmarks[13];         // Pangkal Jari Manis
                        const ringTip = landmarks[16];         // Ujung Jari Manis

                        // PERBAIKAN LOGIKA AI: 
                        // Mengukur dari ujung jari ke pangkal (MCP) alih-alih sendi tengah (PIP) agar 
                        // deteksi lurus atau ditekuk jauh lebih sensitif dan akurat di segala sudut.
                        const getDist = (p1, p2) => Math.hypot(p1.x - p2.x, p1.y - p2.y);
                        
                        const isIndexExtended = getDist(indexTip, wrist) > getDist(indexMCP, wrist) * 1.25;
                        const isMiddleExtended = getDist(middleTip, wrist) > getDist(middleMCP, wrist) * 1.25;
                        const isRingExtended = getDist(ringTip, wrist) > getDist(ringMCP, wrist) * 1.25;

                        // V-Sign (Pause): Telunjuk Lurus, Tengah Lurus, Manis Ditekuk
                        let isVSign = isIndexExtended && isMiddleExtended && !isRingExtended;

                        // Tentukan Status dan Pesan Kursor
                        let fingerActive = false;
                        let msg = "JARI DITEKUK";

                        if (isVSign) {
                            fingerActive = false;
                            msg = "JEDA (‚úåÔ∏è)";
                        } else if (isIndexExtended) {
                            fingerActive = true;
                            msg = "AKTIF";
                        }

                        // Daftarkan koordinat kursor ke dalam game
                        newFingerTips.push({ 
                            x: (indexTip.x * drawWidth) + startX, 
                            y: (indexTip.y * drawHeight) + startY, 
                            active: fingerActive, 
                            message: msg 
                        });
                    });
                }
                indexFingerTips = newFingerTips;
            }

            // Memulai game setelah AI siap membaca setidaknya 1 frame
            if (handsReady && isWaitingForCamera && !isGameRunning) {
                isWaitingForCamera = false;
                startGamePlay();
            }
        });

        // CAMERA - Pemrosesan ringan & stabil
        let isProcessingCamera = false;
        const camera = new Camera(videoElement, { 
            onFrame: async () => { 
                if (isProcessingCamera) return; 
                isProcessingCamera = true;
                try {
                    await hands.send({image: videoElement});
                } catch (error) {
                    console.error("AI Error:", error);
                } finally {
                    isProcessingCamera = false;
                }
            }, 
            width: 640, height: 480 
        });

        // RENDER LOOP TERPISAH DARI AI (Agar Grafis Mulus 60FPS)
        function renderLoop() {
            requestAnimationFrame(renderLoop);
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (videoElement.readyState >= 2 && videoElement.videoWidth > 0) {
                const vW = videoElement.videoWidth;
                const vH = videoElement.videoHeight;
                const videoRatio = vW / vH;
                const canvasRatio = canvasElement.width / canvasElement.height;
                let drawWidth, drawHeight, startX, startY;
                if (canvasRatio > videoRatio) { drawWidth = canvasElement.width; drawHeight = canvasElement.width / videoRatio; startX = 0; startY = (canvasElement.height - drawHeight) / 2; } 
                else { drawHeight = canvasElement.height; drawWidth = canvasElement.height * videoRatio; startX = (canvasElement.width - drawWidth) / 2; startY = 0; }
                canvasCtx.drawImage(videoElement, startX, startY, drawWidth, drawHeight);
            }

            if (isGameRunning) updateAndDrawGame();
            canvasCtx.restore();
        }
        renderLoop();

        // GAME LOGIC
        function updateAndDrawGame() {
            const now = performance.now(); const dt = (now - lastFrameTime) / 1000; lastFrameTime = now;

            timeRemaining -= dt;
            if (timeRemaining <= 0) { timeRemaining = 0; showGameOverScreen(); return; }
            
            timerDisplay.innerText = formatTime(timeRemaining);
            if (timeRemaining < 10) { timerBox.classList.add('border-red-500'); timerDisplay.classList.add('text-red-500'); timerDisplay.classList.remove('text-yellow-400'); }

            spawnTimer += dt; if (spawnTimer > 0.8) { spawnBubble(); spawnTimer = 0; }

            for (let i = bubbles.length - 1; i >= 0; i--) {
                let b = bubbles[i];
                b.y += b.speedY * (dt * 60); b.x += b.speedX * (dt * 60); b.rotation += b.rotSpeed * (dt * 60);
                if (b.x < b.radius || b.x > canvasElement.width - b.radius) b.speedX *= -1;

                // Cek tabrakan gelembung dengan ujung jari yang AKTIF
                let isTouched = false;
                for (let pointer of indexFingerTips) {
                    if (Math.hypot(pointer.x - b.x, pointer.y - b.y) < b.radius + 15) { 
                        if (pointer.active) { isTouched = true; break; } 
                    }
                }

                if (isTouched) {
                    if (b.isTarget) {
                        playCorrectSound(); score += 10; showFloatingText(b.x, b.y, "+10", true);
                        createParticles(b.x, b.y, currentMode === 'warna' ? b.data.hex : '#4ade80');
                        if (currentMode.startsWith('math_')) {
                            generateMathQuestion();
                        }
                    } else {
                        playWrongSound(); score -= 10; showFloatingText(b.x, b.y, "-10", false);
                        createParticles(b.x, b.y, '#ef4444'); 
                        canvasCtx.fillStyle = 'rgba(255, 0, 0, 0.4)'; canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);
                    }
                    updateScoreDisplay(); bubbles.splice(i, 1); continue;
                }

                if (b.y > canvasElement.height + b.radius) { bubbles.splice(i, 1); continue; }

                canvasCtx.save(); canvasCtx.translate(b.x, b.y); canvasCtx.rotate(b.rotation);
                if (currentMode === 'warna') {
                    canvasCtx.beginPath(); canvasCtx.arc(0, 0, b.radius, 0, Math.PI * 2); canvasCtx.fillStyle = b.data.hex; canvasCtx.fill();
                    canvasCtx.lineWidth = 4; canvasCtx.strokeStyle = '#ffffff'; canvasCtx.stroke();
                    canvasCtx.beginPath(); canvasCtx.arc(-b.radius*0.3, -b.radius*0.3, b.radius*0.3, 0, Math.PI * 2); canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.4)'; canvasCtx.fill();
                } else {
                    canvasCtx.beginPath(); canvasCtx.arc(0, 0, b.radius, 0, Math.PI * 2); canvasCtx.fillStyle = 'rgba(30, 64, 175, 0.6)'; canvasCtx.fill();
                    canvasCtx.lineWidth = 3; canvasCtx.strokeStyle = 'rgba(96, 165, 250, 0.9)'; canvasCtx.stroke();
                    canvasCtx.beginPath(); canvasCtx.arc(-b.radius*0.3, -b.radius*0.3, b.radius*0.3, 0, Math.PI * 2); canvasCtx.fillStyle = 'rgba(255, 255, 255, 0.3)'; canvasCtx.fill();
                    canvasCtx.scale(-1, 1); canvasCtx.fillStyle = '#ffffff'; canvasCtx.font = `bold ${b.radius}px 'Segoe UI', Arial`; canvasCtx.textAlign = 'center'; canvasCtx.textBaseline = 'middle';
                    canvasCtx.shadowColor = 'rgba(0,0,0,0.8)'; canvasCtx.shadowBlur = 5; canvasCtx.fillText(b.data, 0, 0);
                }
                canvasCtx.restore();
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                let p = particles[i]; p.x += p.vx * (dt * 60); p.y += p.vy * (dt * 60); p.life -= dt * 3.0; 
                if (p.life <= 0) { particles.splice(i, 1); continue; }
                canvasCtx.globalAlpha = p.life; canvasCtx.beginPath(); canvasCtx.arc(p.x, p.y, 6, 0, Math.PI * 2); canvasCtx.fillStyle = p.color; canvasCtx.fill();
            }
            canvasCtx.globalAlpha = 1.0;

            // RENDER JARI & KURSOR VISUAL
            for (let pointer of indexFingerTips) {
                canvasCtx.beginPath(); canvasCtx.arc(pointer.x, pointer.y, 18, 0, Math.PI * 2);
                if (pointer.active) {
                    canvasCtx.fillStyle = 'rgba(56, 189, 248, 0.8)'; canvasCtx.fill(); canvasCtx.lineWidth = 4;
                    canvasCtx.strokeStyle = '#ffffff'; canvasCtx.shadowColor = '#38bdf8'; canvasCtx.shadowBlur = 15; canvasCtx.stroke();
                } else {
                    canvasCtx.fillStyle = 'rgba(156, 163, 175, 0.4)'; canvasCtx.fill(); canvasCtx.lineWidth = 2;
                    canvasCtx.strokeStyle = 'rgba(255, 255, 255, 0.5)'; canvasCtx.stroke();
                }
                canvasCtx.shadowBlur = 0; 
                canvasCtx.beginPath(); canvasCtx.arc(pointer.x, pointer.y, 4, 0, Math.PI * 2);
                canvasCtx.fillStyle = pointer.active ? '#ffffff' : 'rgba(255,255,255,0.5)'; canvasCtx.fill();

                // Teks Penanda Jari
                canvasCtx.save(); canvasCtx.translate(pointer.x, pointer.y - 35); canvasCtx.scale(-1, 1); 
                canvasCtx.fillStyle = pointer.active ? '#4ade80' : '#f87171'; canvasCtx.font = "bold 14px 'Segoe UI', Arial"; canvasCtx.textAlign = "center";
                canvasCtx.shadowColor = 'rgba(0,0,0,1)'; canvasCtx.shadowBlur = 6; canvasCtx.fillText(pointer.message, 0, 0);
                canvasCtx.restore();
            }
        }
    </script>
</body>
</html>
